# Prometheus Configuration
# ========================
# Metrika gyűjtési és riasztási konfiguráció.
#
# Scrape targets:
# - Prometheus önmagát (self-monitoring)
# - Node Exporter (host metrikák)
# - cAdvisor (container metrikák)
# - Blackbox Exporter (endpoint monitoring)
# - Alertmanager (alert metrikák)

global:
  # Alapértelmezett scrape intervallum
  scrape_interval: 15s
  # Kiértékelési intervallum a szabályokhoz
  evaluation_interval: 15s
  # Külső címkék a riasztásokhoz
  external_labels:
    monitor: "homelab-monitor"
    environment: "production"

# Riasztási szabályok betöltése
rule_files:
  - "/etc/prometheus/alerts/*.yml"

# Alertmanager konfiguráció
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093
      # Timeout az alert küldéshez
      timeout: 10s

# Scrape konfigurációk
scrape_configs:
  # =========================================
  # PROMETHEUS - Self monitoring
  # =========================================
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
    metrics_path: /metrics
    scheme: http

  # =========================================
  # NODE EXPORTER - Host metrikák
  # =========================================
  - job_name: "node-exporter"
    static_configs:
      - targets: ["node-exporter:9100"]
        labels:
          instance: "monitoring-host"
    # Extra metrikák szűrése (opcionális)
    # metric_relabel_configs:
    #   - source_labels: [__name__]
    #     regex: 'node_.*'
    #     action: keep

  # =========================================
  # cADVISOR - Container metrikák
  # =========================================
  - job_name: "cadvisor"
    static_configs:
      - targets: ["cadvisor:8080"]
    # Hosszabb scrape timeout containerekhez
    scrape_timeout: 10s

  # =========================================
  # ALERTMANAGER - Alert metrikák
  # =========================================
  - job_name: "alertmanager"
    static_configs:
      - targets: ["alertmanager:9093"]

  # =========================================
  # BLACKBOX EXPORTER - HTTP Probes
  # =========================================
  - job_name: "blackbox-http"
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          # Monitorozott HTTP endpointok
          - http://prometheus:9090/-/healthy
          - http://grafana:3000/api/health
          - http://alertmanager:9093/-/healthy
        labels:
          probe_type: "internal"
    relabel_configs:
      # A cél URL-t átírjuk target paraméterré
      - source_labels: [__address__]
        target_label: __param_target
      # Az instance címke az eredeti target lesz
      - source_labels: [__param_target]
        target_label: instance
      # A blackbox exporter a valódi target
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # =========================================
  # BLACKBOX EXPORTER - ICMP Probes (Ping)
  # =========================================
  - job_name: "blackbox-icmp"
    metrics_path: /probe
    params:
      module: [icmp]
    static_configs:
      - targets:
          # Pingelendő hostok (példa)
          - 8.8.8.8
          - 1.1.1.1
        labels:
          probe_type: "external_dns"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # =========================================
  # BLACKBOX EXPORTER - TCP Probes
  # =========================================
  - job_name: "blackbox-tcp"
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
          # Monitorozott TCP portok (példa)
          - prometheus:9090
          - grafana:3000
        labels:
          probe_type: "internal_tcp"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # =========================================
  # GRAFANA - Grafana metrikák
  # =========================================
  - job_name: "grafana"
    static_configs:
      - targets: ["grafana:3000"]
    metrics_path: /metrics
